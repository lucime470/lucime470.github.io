<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MySQL运维 | Hexo</title><meta name="author" content="余"><meta name="copyright" content="余"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="MySQL运维 1.日志 1.错误日志   错误日志是 MySQL 中最重要的日志之一，它记录了当mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。   当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。   该日志是默认开启的，默认存放目录&#x2F;var&#x2F;log&#x2F;，默认的日志文件名为mysqld.log。查看日志位置：   1show variables lik">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL运维">
<meta property="og:url" content="http://example.com/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="MySQL运维 1.日志 1.错误日志   错误日志是 MySQL 中最重要的日志之一，它记录了当mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。   当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。   该日志是默认开启的，默认存放目录&#x2F;var&#x2F;log&#x2F;，默认的日志文件名为mysqld.log。查看日志位置：   1show variables lik">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/img/avatar.webp">
<meta property="article:published_time" content="2025-08-27T07:53:59.828Z">
<meta property="article:modified_time" content="2025-08-27T12:18:30.928Z">
<meta property="article:author" content="余">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MySQL运维",
  "url": "http://example.com/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/",
  "image": "http://example.com/img/avatar.webp",
  "datePublished": "2025-08-27T07:53:59.828Z",
  "dateModified": "2025-08-27T12:18:30.928Z",
  "author": [
    {
      "@type": "Person",
      "name": "余",
      "url": "http://example.com"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL运维',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Hexo</span></a><a class="nav-page-title" href="/"><span class="site-name">MySQL运维</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">MySQL运维</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-08-27T07:53:59.828Z" title="Created 2025-08-27 15:53:59">2025-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-08-27T12:18:30.928Z" title="Updated 2025-08-27 20:18:30">2025-08-27</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1>MySQL运维</h1>
<h2 id="1-日志">1.日志</h2>
<h3 id="1-错误日志">1.错误日志</h3>
<ul>
<li>
<p>错误日志是 MySQL 中最重要的日志之一，它记录了当mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。</p>
</li>
<li>
<p>当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</p>
</li>
<li>
<p>该日志是默认开启的，默认存放目录/var/log/，默认的日志文件名为mysqld.log。查看日志位置：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_error%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-二进制日志">2.二进制日志</h3>
<h4 id="1-介绍">1.介绍</h4>
<ul>
<li>
<p>二进制日志（binlog）记录了所有ddl（数据定义语言）语句和dml（数据操纵语言）语句，但不包括数据查询（select，show）语句</p>
</li>
<li>
<p>作用：</p>
<ul>
<li>
<p>灾难时的数据恢复，数据库崩溃后再次执行二进制日志中的内容就可以恢复</p>
</li>
<li>
<p>MySQL的主从复制。在MySQL8版本中，默认二进制日志是开启的，涉及参数：</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>可以查询到：</p>
<ul>
<li>log_bin：开启或关闭</li>
<li>log_bin_basename：日志文件位置，文件由binlog和编号组成</li>
<li>log_bin_index：索引文件位置</li>
</ul>
</li>
</ul>
<h4 id="2-日志格式">2.日志格式</h4>
<table>
<thead>
<tr>
<th>日志格式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>statement</td>
<td>基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志文件中</td>
</tr>
<tr>
<td>row</td>
<td>基于行的日志记录，记录的是每一行的数据变更（默认）</td>
</tr>
<tr>
<td>mixed</td>
<td>混合了statement和row两种格式，默认采用statement，在某些特殊情况下会自动切换为row进行记录</td>
</tr>
</tbody>
</table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%binlog_format%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p># 查询日志格式</p>
<p># 需要在文件中修改日志格式</p>
<p># 修改后会在新的日志文件中记录</p>
<h4 id="3-日志查看">3.日志查看</h4>
<ul>
<li>
<p>由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具mysqlbinlog来查看</p>
</li>
<li>
<p>语法：</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog 选项 日志文件名</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>选项：</p>
<ul>
<li>-d，指定数据库名称，只列出指定的数据库相关操作</li>
<li>-o，忽略掉日志中的前n行命令</li>
<li>-v，将行事件（数据变更）重构为SQL语句</li>
<li>-w，将行事件（数据变更）重构为SQL语句，并输出注释信息</li>
</ul>
</li>
</ul>
<h4 id="4-日志删除">4.日志删除</h4>
<ul>
<li>对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间</li>
</ul>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>reset master;</td>
<td>删除全部binlog日志，删除之后，日志编号，将从binlog.000001重新开始</td>
</tr>
<tr>
<td>purge master logs to ‘binlog.xxxxxx’;</td>
<td>删除xxxxxx编号之前的所有日志（此编号不会被删除）</td>
</tr>
<tr>
<td>purge master logs before ‘yyyy-mm-dd hh24:mi:ss’;</td>
<td>删除日志为’yyyy-mm-dd hh24:mi:ss’之前产生的所有日志</td>
</tr>
</tbody>
</table>
<ul>
<li>也可以在mysql的配置文件中配置二进制日志的过期时间，设置后，二进制日志过期会自动删除</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%binlog_expire_logs_seconds%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p># 默认30天</p>
<h3 id="3-查询日志">3.查询日志</h3>
<ul>
<li>
<p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。默认情况下，查询日志是未开启的</p>
</li>
<li>
<p>涉及参数：general_log</p>
</li>
<li>
<p>修改MySQL的配置文件/etc/my.cnf文件，添加内容：</p>
</li>
<li>
<p><strong>general_log=1</strong></p>
</li>
</ul>
<p># 开启</p>
<ul>
<li>general_log_file=目录/文件名</li>
</ul>
<p># 指定文件名，默认文件名为主机名.log</p>
<h3 id="4-慢查询日志">4.慢查询日志</h3>
<ul>
<li>
<p>慢查询日志记录了所有执行时间超过参数long_query_time 设置值并且扫描记录数不小于min_examined_rowlimit的所有的SQL语句的日志，默认未开启。long_query_time 默认为10秒，最小为0，精度可以到微秒。</p>
</li>
<li>
<p>默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以在MySQL的配置文件/etc/my.cnf文件中修改log_slow_admin_statements和更改此行为log_queries_not_using_indexes</p>
</li>
<li>
<p><strong>log_slow_admin_statements=1</strong></p>
</li>
</ul>
<p># 记录执行较慢的管理语句</p>
<ul>
<li><strong>log_queries_not_using_indexes=1</strong></li>
</ul>
<p># 记录执行较慢的未使用索引的语句</p>
<h2 id="2-主从复制">2.主从复制</h2>
<h3 id="1-概述">1.概述</h3>
<ul>
<li>
<p>主从复制是指将主数据库的DDL 和 DML操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库（slave）和主库（master）的数据保持同步。</p>
</li>
<li>
<p>MySQL支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库，实现链状复制。</p>
</li>
<li>
<p>作用：</p>
<ul>
<li>1.主库出现问题，可以快速切换到从库提供服务。</li>
<li>2.实现读写分离，降低主库的访问压力。</li>
<li>3.可以在从库中执行备份，以避免备份期间影响主库服务。</li>
</ul>
</li>
</ul>
<h3 id="2-原理">2.原理</h3>
<ul>
<li>主要分为三步：
<ul>
<li>1.Master 主库在事务提交时，会把数据变更记录在二进制日志文件 binlog中。</li>
<li>2.从库的IOthread读取主库的二进制日志文件 binlog，写入到从库的中继日志Relay Log。</li>
<li>3.slave从库的SQLthread读取中继日志，再将改变反映它自己的数据。</li>
</ul>
</li>
</ul>
<h3 id="3-搭建">3.搭建</h3>
<h4 id="1-服务器准备">1.服务器准备</h4>
<ul>
<li>
<p>主库和从库</p>
</li>
<li>
<p>关闭服务器的防火墙</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure>
<p># 关闭防火墙</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<p># 关闭防火墙的开机自启动</p>
<ul>
<li>或者</li>
<li>开放指定的端口号</li>
</ul>
<h4 id="2-主库配置">2.主库配置</h4>
<h5 id="1-修改配置文件-etc-my-cnf">1.修改配置文件/etc/my.cnf</h5>
<ul>
<li><strong>server-id=1</strong></li>
</ul>
<p># mysql服务id，保证整个集群环境中唯一，取值范围：1~2^32-1，默认为1</p>
<ul>
<li><strong>read-only=0</strong></li>
</ul>
<p># 是否只读，1代表只读，0代表读写</p>
<ul>
<li><strong>binlog-ignore-db=数据库名</strong></li>
</ul>
<p># 忽略数据库，指不需要同步的数据库</p>
<ul>
<li><strong>binlog-do-db=数据库名</strong></li>
</ul>
<p># 指定同步的数据库</p>
<h5 id="2-重启MySQL服务器">2.重启MySQL服务器</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<p># 没有报错则配置成功</p>
<h5 id="3-登录mysql，创建远程连接的账号，并授予主从复制权限">3.登录mysql，创建远程连接的账号，并授予主从复制权限</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;%&#x27;</span>identified <span class="keyword">with</span> mysql_native_password <span class="keyword">by</span> <span class="string">&#x27;密码&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p># 创建用户，并设置密码，因为主机名设置为%所以该用户可在任意主机连接该MySQL服务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> replication slave <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p># 为用户分配主从复制权限</p>
<h5 id="4-通过指令，查看二进制日志坐标">4.通过指令，查看二进制日志坐标</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>字段含义说明：</p>
<ul>
<li>file：从哪个日志文件开始推送日志文件</li>
<li>position：从哪个位置开始推送日志</li>
<li>binlog_ignore_db：指定不需要同步的数据库</li>
</ul>
</li>
</ul>
<h4 id="3-从库配置">3.从库配置</h4>
<h5 id="1-修改配置文件-etc-my-cnf-2">1.修改配置文件/etc/my.cnf</h5>
<ul>
<li><strong>server-id=2</strong></li>
</ul>
<p># mysql服务id，保证整个集群环境中唯一，取值范围：1~2^32-1，和主库不一样即可</p>
<ul>
<li><strong>read-only=1</strong></li>
</ul>
<p># 是否只读，1代表只读，0代表读写</p>
<ul>
<li><strong>super-read-only=1</strong></li>
</ul>
<p># 可以将超级管理员也设置为只读，否则也能读写</p>
<h5 id="2-重启MySQL服务器-2">2.重启MySQL服务器</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<p># 没有报错则配置成功</p>
<h5 id="3-登录mysql，设置主库配置">3.登录mysql，设置主库配置</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change replication source <span class="keyword">to</span> source_host<span class="operator">=</span><span class="string">&#x27;原主机ip地址&#x27;</span>,source_user<span class="operator">=</span><span class="string">&#x27;用户名&#x27;</span>,source_password<span class="operator">=</span><span class="string">&#x27;密码&#x27;</span>,source_log_file<span class="operator">=</span><span class="string">&#x27;对应二进制日志文件&#x27;</span>,source_log_pos<span class="operator">=</span>从日志中的哪个位置开始同步;</span><br></pre></td></tr></table></figure>
<p># 从日志中的哪个位置开始同步，可以查看二进制日志坐标中的position</p>
<ul>
<li>老版本</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change master <span class="keyword">to</span> master_host<span class="operator">=</span><span class="string">&#x27;原主机ip地址&#x27;</span>,master_user<span class="operator">=</span><span class="string">&#x27;用户名&#x27;</span>,master_password<span class="operator">=</span><span class="string">&#x27;密码&#x27;</span>,master_log_file<span class="operator">=</span><span class="string">&#x27;对应二进制日志文件名&#x27;</span>,master_log_pos<span class="operator">=</span>从日志中的哪个位置开始同步;</span><br></pre></td></tr></table></figure>
<h5 id="4-开启同步操作">4.开启同步操作</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> replica;</span><br></pre></td></tr></table></figure>
<ul>
<li>老版本(新版本也兼容)</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>
<h5 id="5-查看主从同步状态">5.查看主从同步状态</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> replica status;</span><br></pre></td></tr></table></figure>
<ul>
<li>老版本</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status;</span><br></pre></td></tr></table></figure>
<p># 状态中<strong>Replica_IO_Running</strong> 和<strong>Replica_SQL_Running</strong> 为<strong>Yes</strong> 说明主从复制正常</p>
<h2 id="3-分库分表">3.分库分表</h2>
<h3 id="1-介绍-2">1.介绍</h3>
<h4 id="1-问题分析">1.问题分析</h4>
<ul>
<li>
<p>随着互联网及移动互联网的发展，应用系统的数据量也是成指数式增长，若采用单数据库进行数据存储，存在以下性能瓶颈：</p>
<ul>
<li>1.IO瓶颈：热点数据太多，数据库缓存不足，产生大量磁盘IO，效率较低。请求数据太多，带宽不够，网络IO瓶颈。</li>
<li>2.CPU瓶颈：排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出现瓶颈。</li>
</ul>
</li>
<li>
<p>分库分表的中心思想都是将数据分散存储，使得单一数据库/表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。</p>
</li>
</ul>
<h4 id="2-拆分策略">2.拆分策略</h4>
<ul>
<li>
<p>垂直拆分</p>
<ul>
<li>垂直分库：以表为依据，根据业务将不同表拆分到不同库中。
<ul>
<li>每个库的表结构都不一样</li>
<li>每个库的数据也不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
</li>
<li>垂直分表：以字段为依据,根据字段属性将不同字段拆分到不同表中。
<ul>
<li>每个表的结构都不一样</li>
<li>每个表的数据也不一样，一般通过一列（主键/外键）关联</li>
<li>所有表的并集是全量数据</li>
</ul>
</li>
</ul>
</li>
<li>
<p>水平拆分</p>
<ul>
<li>水平分库：以字段为依据，按照一定策略，将一个库的数据拆分到多个库中。
<ul>
<li>每个库的表结构都一样</li>
<li>每个库的数据都不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
</li>
<li>水平分表：以字段为依据，按照一定策略，将一个表的数据拆分到多个库中。
<ul>
<li>每个表的表结构都一样</li>
<li>每个表的数据都不一样</li>
<li>所有表的并集是全量数据</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="3-实现技术">3.实现技术</h4>
<ul>
<li>shardingJDBC：基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java语言，性能较高。</li>
<li>MyCat：数据库分库分表中间件，不用调整代码即可实现分库分表，支持多种语言，性能不及前者。</li>
</ul>
<h3 id="2-MyCat概述">2.MyCat概述</h3>
<h4 id="1-介绍-3">1.介绍</h4>
<ul>
<li>
<p>Mycat是开源的、活跃的、基于Java语言编写的MySQL数据库中间件。mycat伪装了mysql的协议，所以可以像使用mysql一样来使用mycat，对于开发人员来说根本感觉不到mycat的存在。</p>
</li>
<li>
<p>优势：</p>
<ul>
<li>性能可靠稳定</li>
<li>强大的技术团队</li>
<li>体系完善</li>
<li>社区活跃</li>
</ul>
</li>
<li>
<p>MyCat中间件服务器需要安装jdk和mycat</p>
</li>
<li>
<p>mycat解压后有主要四个目录：</p>
<ul>
<li>bin：存放可执行文件，用于启动停止mycat</li>
<li>conf：存放mycat的配置文件</li>
<li>lib：存放mycat的项目依赖包（jar）</li>
<li>logs：存放mycat的日志文件</li>
</ul>
</li>
</ul>
<h4 id="2-概念介绍">2.概念介绍</h4>
<ul>
<li>逻辑结构：</li>
<li>逻辑库
<ul>
<li>逻辑表
<ul>
<li>分片节点</li>
</ul>
</li>
</ul>
</li>
<li>物理结构：</li>
<li>节点主机（与分片节点相连）</li>
</ul>
<h3 id="3-MyCat入门">3.MyCat入门</h3>
<h4 id="1-需求">1.需求</h4>
<ul>
<li>由于 tb_order 表中数据量很大，磁盘IO及容量都到达了瓶颈，现在需要对tb_order表进行数据分片，分为三个数据节点，每一个节点主机位于不同的服务器上。</li>
</ul>
<h4 id="2-环境准备">2.环境准备</h4>
<ul>
<li>需要在三台服务器上都建立一个空的数据库</li>
<li>将防火墙关闭或者直接开放指定端口</li>
</ul>
<h4 id="3-分片配置（schema-xml）">3.分片配置（schema.xml）</h4>
<ul>
<li>修改mycat中conf中的schema.xml文件</li>
</ul>
<p># 可以用notepad++的插件NppFTP，show NppFTP Windows，便于编辑</p>
<ul>
<li>1.配置table（逻辑表）的表名</li>
<li>2.配置dataNode（数据节点）的数据节点名</li>
<li>3.配置数据节点连接的dataHost（节点主机）的节点主机名</li>
<li>4.配置关联的节点主机的database（数据库）的数据库名</li>
<li>5.在下面的dataHost中详细配置关联的服务器的ip地址，端口号以及用户名和密码</li>
</ul>
<h4 id="4-分片配置（server-xml）">4.分片配置（server.xml）</h4>
<ul>
<li>
<p>修改mycat中conf中的server.xml文件</p>
</li>
<li>
<p>配置mycat的用户及用户的权限信息</p>
</li>
<li>
<p>将user中的schemas后面的testdb改为数据库名</p>
</li>
<li>
<p>在readOnly后可以配置是否只可读</p>
</li>
</ul>
<h4 id="5-启动服务">5.启动服务</h4>
<ul>
<li>切换到mycat的安装目录，执行指令启动mycat</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/mycat start</span><br></pre></td></tr></table></figure>
<p># 启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/mycat stop</span><br></pre></td></tr></table></figure>
<p># 停止</p>
<p># mycat启动后占用端口号8066</p>
<ul>
<li>
<p>启动完成后可以查看logs目录下的启动日志，查看mycat是否启动完成</p>
</li>
<li>
<p>登录</p>
</li>
<li>
<p>和MySQL一样</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 主机ip地址 -P 8066 -u root -p</span><br></pre></td></tr></table></figure>
<h3 id="4-MyCat配置">4.MyCat配置</h3>
<h4 id="1-schema-xml">1.schema.xml</h4>
<ul>
<li>schema.xml作为MyCat中最重要的配置文件之一，涵盖了MyCat的逻辑库、逻辑表、分片规则、分片节点及数据源的配置。</li>
<li>主要包含三组标签</li>
</ul>
<h5 id="1-schema">1.schema</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;DB01&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name-</span>&quot;<span class="attr">TB</span> <span class="attr">ORDER</span>&quot; <span class="attr">dataNode</span>=<span class="string">&quot;dnl,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>schema标签用于定义 MyCat实例中的逻辑库，一个MyCat实例中，可以有多个逻辑库，可以通过 schema标签来划分不同的逻辑库。</p>
</li>
<li>
<p>MyCat中的逻辑库的概念，等同于ySQL中的database概念，需要操作某个逻辑库下的表时，也需要切换逻辑库(use xxx)。</p>
</li>
<li>
<p>核心属性：</p>
<ul>
<li>name：指定自定义的逻辑库库名</li>
<li>checksdLschema：在SOL语句操作时指定了数据库名称，执行时是否自动去除；true：自动去除，false：不自动去除</li>
<li>sqlMaxLimit：如果未指定limit进行查询，列表查询模式查询多少条记录</li>
</ul>
</li>
<li>
<p>子标签table</p>
<ul>
<li>table标签定义了MyCat中逻辑库schema下的逻辑表，所有需要拆分的表都需要在table标签中定义。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;DB01&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name-</span>&quot;<span class="attr">TB</span> <span class="attr">ORDER</span>&quot; <span class="attr">dataNode</span>=<span class="string">&quot;dnl, dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>核心属性：</p>
<ul>
<li>name：定义逻辑表表名，在该逻辑库下唯一</li>
<li>dataNode：定义逻辑表所属的dataNode，该属性需要与dataNode标签中name对应；多个dataNode逗号分隔</li>
<li>rule：分片规则的名字，分片规则名字是在rule.xml中定义的</li>
<li>primaryKey：逻辑表对应真实表的主键</li>
<li>type：逻辑表的类型，目前逻辑表只有全局表和普通表，如果未配置，就是普通表；全局表，配置为global</li>
</ul>
</li>
</ul>
<h5 id="2-dataNode">2.dataNode</h5>
<ul>
<li>dataNode标签中定义了MyCat中的数据节点，也就是我们通常说的数据分片。一个dataNode标签就是一个独立的数据分片。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;dbo1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;dbo1&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database-</span>&quot;<span class="attr">dbo1</span>&quot;&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>核心属性：
<ul>
<li>name：定义数据节点名称</li>
<li>dataHost：数据库实例主机名称，引用自dataHost 标签中name属性</li>
<li>database：定义分片所属数据库</li>
</ul>
</li>
</ul>
<h5 id="3-dataHost">3.dataHost</h5>
<ul>
<li>dataHost标签在MyCat逻辑库中作为底层标签存在，直接定义了具体的数据库实例、读写分离、心跳语句。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.210:3306?useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai&amp;amp:characterEncoding-utf8&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">&lt;/dataHost》</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>核心属性：</p>
<ul>
<li>name：唯一标识，供上层标签使用</li>
<li>maxCon/minCon: 最大连接数/最小连接数</li>
<li>balance:负载均衡策略，取值0,1,2,3</li>
<li>writeType：写操作分发方式（0：写操作转发到第一个writeHost，第一个挂了，切换到第二个；1：写操作随机分发到配置的writeHost）</li>
<li>dbDriver：数据库驱动，支持native、jdbc</li>
</ul>
</li>
</ul>
<h4 id="2-rule-xml">2.rule.xml</h4>
<ul>
<li>rule.xml中定义所有拆分表的规则，在使用过程中可以灵活的使用分片算法，或者对同一个分片算法使用不同的参数，它让分片过程可配置化。主要包含两类标签：tableRule、Function</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">colunsJ</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name-</span>&quot;<span class="attr">mapFile</span>&quot;&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 关联的分片算法rang-long，封装在外部文件autopartition-long.txt</p>
<h4 id="3-server-xml">3.server.xml</h4>
<ul>
<li>
<p>server.xml配置文件包含了MyCat的系统配意信息，主要有两个重要的标签：System、user。</p>
</li>
<li>
<p>system</p>
<ul>
<li>对应的系统配置项及其含义，参考资料。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nonePasswordLogin&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useHandshakeV10&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;useSqlStat&quot;</span>&gt;</span>l<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>user</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>schemas后的表示该用户可以访问的逻辑库，多个逻辑库之间逗号分隔</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">privileges</span> <span class="attr">check</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">dml</span>=<span class="string">&quot;0110&quot;</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb01&quot;</span> <span class="attr">dml</span>=<span class="string">&quot;0000&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb02&quot;</span> <span class="attr">dml</span>=<span class="string">&quot;1111&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">privileges</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># &lt;privileges check=“false”&gt;表示是否开启DML权限检查，默认为false</p>
<p># &lt;schema name=“TESTDB” dml=“0110”&gt;配置指定逻辑库的权限</p>
<p># &lt;table name=“tb01” dml=“0000”&gt;&lt;/table&gt;配置指定逻辑表的权限，就近原则：以逻辑表为准（如果配置了逻辑表权限）</p>
<p># 0000，用二进制数对应IUSD（增改查删，例如1010则为增和查）的权限</p>
<h3 id="5-MyCat分片">5.MyCat分片</h3>
<h4 id="1-垂直拆分">1.垂直拆分</h4>
<h5 id="1-场景">1.场景</h5>
<ul>
<li>
<p>在业务系统中，涉及以下表结构，但是由于用户与订单每天都会产生大量的数据，单台服务器的数据存储及处理能力是有限的，可以对数据库表进行拆分，原有的数据库表如下</p>
<ul>
<li>省市区</li>
<li>商品
<ul>
<li>基础信息</li>
<li>品牌</li>
<li>分类</li>
<li>编号</li>
<li>详细信息</li>
</ul>
</li>
<li>订单
<ul>
<li>详细信息</li>
<li>支付记录</li>
</ul>
</li>
<li>用户
<ul>
<li>用户名</li>
<li>用户地址</li>
</ul>
</li>
</ul>
</li>
<li>
<p>将用户和省市区，商品，订单存放在三个分片中</p>
</li>
</ul>
<h5 id="2-准备">2.准备</h5>
<ul>
<li>在三台MySQL中创建数据库shopping</li>
</ul>
<h5 id="3-配置">3.配置</h5>
<ul>
<li>在schema中配置逻辑库，逻辑表，以及指定每一个逻辑表所关联的数据节点</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;SHOPPING&quot;</span> <span class="attr">checksgLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb goods base&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dnl&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb goods brand&quot;</span> <span class="attr">dataNode-</span>&quot;<span class="attr">dnl</span>&quot; <span class="attr">primaryKey</span>&quot;<span class="attr">id</span>&quot;/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb goods cat&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;th goods desc&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dnl&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb goods item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dnl&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb order item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb order master&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;order id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb order pay log&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;out trade no&quot;</span>/&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;th user address&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb areas provinces&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb areas city&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb areas region&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhostl&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name-</span>&quot;<span class="attr">dn3</span>&quot; <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="4-测试">4.测试</h5>
<ul>
<li>在mycat命令行中，通过source指令导入表结构，以及对应的数据，查看数据分布情况</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /目录/文件名</span><br></pre></td></tr></table></figure>
<ul>
<li>查询用户的收件人及收件人地址信息（多表联查）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ua.user_id, ua.contact, p.province, c.city, r.area , ua.address <span class="keyword">from</span> tb_user address ua ,tb_areas_city c, tb_areas_provinces p,tb_areas_region r <span class="keyword">where</span> ua.province_id <span class="operator">=</span> p.provinceid <span class="keyword">and</span> ua.city_id <span class="operator">=</span> c.cityid <span class="keyword">and</span> ua.town_id <span class="operator">=</span> r.areaid;</span><br></pre></td></tr></table></figure>
<ul>
<li>查询每一笔订单及订单的收件地址信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> order_id , payment,receiver,province,city,area <span class="keyword">FROM</span> tb_order_master o , tb_areas_provinces p , tb_areas_city c, tb_areas_region r <span class="keyword">WHERE</span> o.receiver_province <span class="operator">=</span> p.provinceid <span class="keyword">AND</span> o.receiver_city <span class="operator">=</span> c.cityid <span class="keyword">AND</span> o.receiver_region <span class="operator">=</span> r.areaid;</span><br></pre></td></tr></table></figure>
<p># 这里直接执行会报错，这是跨两库的多表联查</p>
<h5 id="5-全局表配置">5.全局表配置</h5>
<ul>
<li>对于省、市、区/县表tb_areas_provinces,tb_areas_city,tb_areas_region，是属于数据字典表，在多个业务模块中都可能会遇到，可以将其设置为全局表，利于业务操作。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_provinces&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dnl,dn2,dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span><span class="attr">type</span>=<span class="string">&quot;global&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p># 对三张表进行全局配置，查询的时候就会把这三张表路由到订单的数据库中，这样就能实现跨两库的多表联查</p>
<p># 全局表更新后关联的其他三个库中的表也会更新</p>
<h4 id="2-水平拆分">2.水平拆分</h4>
<h5 id="1-场景-2">1.场景</h5>
<ul>
<li>在业务系统中，有一张表(日志表，业务系统每天都会产生大量的日志数据，单台服务器的数据存储及处理能力是有限的，可以对数据库表进行拆分。</li>
</ul>
<h5 id="2-准备-2">2.准备</h5>
<ul>
<li>在三台MySQL中创建数据库itcast</li>
</ul>
<h5 id="3-配置-2">3.配置</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;ITCAST&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_log&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn4,dn5,dn6&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn4&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhosti&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn5&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn6&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p># 这里rule=&quot;mod-long&quot;将分片规则配置为取模</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING,ITCAST<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 增加访问的逻辑库</p>
<ul>
<li>创建表结构并导入数据</li>
</ul>
<h4 id="3-分片规则">3.分片规则</h4>
<h5 id="1-范围（auto-sharding-long）">1.范围（auto-sharding-long）</h5>
<ul>
<li>根据指定的字段及其配置的范围与数据节点的对应情况，来决定该数据属于哪一个分片。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name-</span>&quot;<span class="attr">tb</span> <span class="attr">operate</span>&quot; <span class="attr">dataNode-</span>&quot;<span class="attr">dn4</span>,<span class="attr">dn5</span>,<span class="attr">dn6</span>&quot; <span class="attr">rule</span>&quot;<span class="attr">auto-sharding-long</span>&quot; /&gt;</span></span><br></pre></td></tr></table></figure>
<p># 在schema.xml中通过rule来指定对应的分片规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto-sharding-long&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;<span class="name">columns</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p># rule&quot;auto-sharding-long&quot;分片规则引用的是rule.xml中定义的分片规则</p>
<p># &lt;columns&gt;id&lt;columns&gt;定义了根据id字段进行分片</p>
<p># &lt;algorithm&gt;rang-long&lt;/algorithm&gt;分片对应的算法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span> &gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># &lt;algorithm&gt;rang-long&lt;/algorithm&gt;引用rule.xml中的function</p>
<p># class=&quot;io.mycat.route.function.AutoPartitionByLong&quot;这个java类中对分片规则进行定义解析</p>
<p># &lt;property name=“mapFile” &gt;autopartition-long.txt&lt;/property&gt;又引用了一个外部文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># range start-end ,data node index</span><br><span class="line"># K=1000,M=10000.</span><br><span class="line">0-500M=0</span><br><span class="line">500M-1000M=1</span><br><span class="line">1000M-1500M=2</span><br></pre></td></tr></table></figure>
<p># autopartition-long.txt这个外部文件中具体配置了范围对应的节点</p>
<h5 id="2-取模（mod-long）">2.取模（mod-long）</h5>
<ul>
<li>根据指定的字段值与节点数量进行求模运算，根据运算结果，来决定该数据属于哪一个分片。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 在rule.xml中配置节点数</p>
<h5 id="3-一致性hash（sharding-by-murmur）">3.一致性hash（sharding-by-murmur）</h5>
<ul>
<li>所谓一致性哈希，将字符串字段根据哈希计算，相同的哈希因子计算值总是被划分到相同的分区表中，不会因为分区节点的增加而改变原来数据的分区位置。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># function中配置节点数</p>
<h5 id="4-枚举（sharding-by-intfile）">4.枚举（sharding-by-intfile）</h5>
<ul>
<li>通过在配置文件中配置可能的枚举值,指定数据分布到不同数据节点上,本规则适用于按照省份、性别、状态拆分数据等业务。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># function配置默认节点值，当插入的数据超出了指定的枚举值则默认存储到这个节点</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># function中引用外部文件，在partition-hash-int.txt这个文件中直接定义例如3=1，则字段值为3时存到第2个节点，节点是从0开始的</p>
<ul>
<li>如果有不同的字段要用同一种分片规则，则可以将原本的分片规则复制黏贴，修改规则名称，修改字段，对应的算法不更改</li>
</ul>
<h5 id="5-应用指定（sharding-by-substring）">5.应用指定（sharding-by-substring）</h5>
<ul>
<li>运行阶段由应用自主决定路由到那个分片，直接根据子字符串（必须是数字，例如截取前2个数字）计算分片号。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-substring&quot;</span></span></span><br><span class="line"><span class="tag">	&lt;<span class="attr">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>sharding-by-substring<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-substring&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionDirectBySubString&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;startIndex&quot;</span>&gt;</span>O<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;size&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultPartition&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 这个分片规则不在默认的样例中，需要自行添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;startIndex&quot;</span>&gt;</span>O<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 在function中配置开始索引</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;size&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 配置截取长度</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 配置分片数量</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultPartition&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 配置默认分片，截取出来的子字符串不在分片数量范围内则存储到默认分片</p>
<h5 id="6-固定分片hash算法（sharding-by-long-hash）">6.固定分片hash算法（sharding-by-long-hash）</h5>
<ul>
<li>
<p>该算法类似于十进制的求模运算，但是为二进制的操作，会将指定字段（值必须是数字）的二进制的前10位与1111111111进行位&amp;运算。</p>
</li>
<li>
<p>位&amp;运算：将前十位的每一位数与1111111111中的相同位置的数字进行对比，相同则为1，不同则为0，获得一个新的数字。1111111111对应的十进制数是2^10-1=1023，所以这里的位&amp;运算得出的结果位于0-1023</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>如果是求模，连续的值，分别分配到各个不同的分片；但是此算法会将连续的值可能分配到相同的分片，降低事务处理的难度。</li>
<li>可以均匀分配到节点，也可以非均匀分配。</li>
<li>分片字段必须为数字类型。</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionCount&quot;</span>&gt;</span>2,1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>256,512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 2,1表示共三个节点，前两个长度都是256，后一个是512（总的分片长度默认最大为1024）</p>
<p># 2,1和256,512这里配置的数字个数必须对应</p>
<h5 id="7-字符串hash解析（sharding-by-stringhash）">7.字符串hash解析（sharding-by-stringhash）</h5>
<ul>
<li>截取字符串中的指定位置的子字符串，进行哈希运算，算出哈希值与1023进行位&amp;运算，算出分片。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-stringhash&quot;</span></span></span><br><span class="line"><span class="tag">	&lt;<span class="attr">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>name<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-stringhash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByString&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;&#x27;partitionCount&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashslice&quot;</span>&gt;</span>0:2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 这个分片规则也是需要自行添加的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;partitionLength&quot;</span>&gt;</span>512<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;&#x27;partitionCount&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 两个节点各512长度</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hashslice&quot;</span>&gt;</span>0:2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># hash运算位，格式start:end，start从0开始。0在end中出现代表str.length()，-1代表str.length()-1，大于0代表数字本身</p>
<h5 id="8-按（天）日期分片（sharding-by-date）">8.按（天）日期分片（sharding-by-date）</h5>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;sharding-by-date&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span>		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateformat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBecinDate&quot;</span>&gt;</span>2022-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2022-01-30<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 需要自行配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;daterormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 日期格式</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2022-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 起始时间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2022-01-30<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 截止时间</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 分片周期，每十天位一个分片，到达结束时间后，后面的日期再插入，会重复开始分片插入</p>
<p># dataNode的分片数量必须和这里的分片规则的数量一致，例如从同一年的01-01到12-31，每十天一个分片，则需要37个分片，没有则报错</p>
<h5 id="9-按自然月分片（sharding-by-month）">9.按自然月分片（sharding-by-month）</h5>
<ul>
<li>
<p>mycat中自带的分片规则</p>
</li>
<li>
<p>和按天分片一样需要配置日期格式和起始截止日期</p>
</li>
<li>
<p>一个月为一个分片，到达结束时间后，后面的日期再插入，会重复开始分片插入</p>
</li>
<li>
<p>dataNode的分片数量必须和这里的分片规则的数量一致，例如从同一年的01-01到12-31，每一个月一个分片，则需要12个分片，没有则报错</p>
</li>
</ul>
<h3 id="6-MyCat管理及监控">6.MyCat管理及监控</h3>
<h4 id="1-MyCat原理">1.MyCat原理</h4>
<ul>
<li>
<p>客户端发送插入的SQL语句到mycat</p>
</li>
<li>
<p>mycat</p>
<ul>
<li>解析SQL</li>
<li>分片分析</li>
<li>路由分析，路由到相对应的节点中</li>
<li>读写分离分析</li>
<li>…</li>
</ul>
</li>
<li>
<p>客户端发送查询的SQL语句到mycat</p>
</li>
<li>
<p>mycat</p>
<ul>
<li>解析SQL</li>
<li>分片分析，如果字段值不在规则范围内或者没有这个字段值，则接下来的路由分析会路由到所有库中</li>
<li>路由分析</li>
<li>读写分离分析</li>
<li>…</li>
</ul>
</li>
<li>
<p>分片节点</p>
<ul>
<li>接收到SQL语句</li>
<li>执行后返回结果到mycat</li>
</ul>
</li>
<li>
<p>mycat</p>
<ul>
<li>结果合并</li>
<li>聚合处理</li>
<li>排序处理</li>
<li>分页处理</li>
<li>…</li>
<li>结果返回到客户端</li>
</ul>
</li>
</ul>
<h4 id="2-MyCat管理">2.MyCat管理</h4>
<ul>
<li>
<p>Mycat默认开通2个端口，可以在server.xml中进行修改。</p>
<ul>
<li>
<p>8066数据访问端口，即进行DML和DDL操作。</p>
</li>
<li>
<p>9066数据库管理端口，即mycat服务管理控制功能，用于管理mycat的整个集群状态</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h ip地址 -P 9066 -uroot -p密码</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>show @@help</td>
<td>查看Mycat管理工具帮助文档</td>
</tr>
<tr>
<td>show @@version</td>
<td>查看Mycat的版本</td>
</tr>
<tr>
<td>reload @@config</td>
<td>重新加载Mycat的配置文件</td>
</tr>
<tr>
<td>show @@datasouorce</td>
<td>查Mycat的数据源信息</td>
</tr>
<tr>
<td>show @@datanode</td>
<td>查看MyCat现有的分片节点信息</td>
</tr>
<tr>
<td>show @@threadpool</td>
<td>查看Mycat的线程池信息</td>
</tr>
<tr>
<td>show @@sql</td>
<td>查看执行的SQL</td>
</tr>
<tr>
<td>show @@sql.sum</td>
<td>查看执行的SQL统计</td>
</tr>
</tbody>
</table>
<h4 id="3-MyCat-eye">3.MyCat-eye</h4>
<ul>
<li>
<p>Mlycat-web(Mycat-eye)是对mycat-server提供监控服务，功能不局限于对mycat-server使用。他通过JDBC连接对Mycat、Mysal监控，监控远程服务器(目前仅限于linux系统)的cpu、内存、网络、磁盘。</p>
</li>
<li>
<p>Mycat-eye运行过程中需要依赖zookeeper，因此需要先安装zookeeper。</p>
</li>
<li>
<p>在mycat-web文件夹下</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh start.sh</span><br></pre></td></tr></table></figure>
<p># 启动mycat-web</p>
<ul>
<li>
<p>在浏览器中输入网址：服务器ip：8082/mycat进入网站（需要关闭服务器的防火墙）</p>
</li>
<li>
<p>在网站中进入mycat配置中的mycat服务配置</p>
</li>
<li>
<p>管理端口：9066</p>
</li>
<li>
<p>服务端口：8066</p>
</li>
<li>
<p>数据库名称：这里要配置mycat-server配置文件schema.xml中schema标签配置的name。</p>
</li>
<li>
<p>用户名：这里要配置mycat-server配置文件server.xml中user标签中name配置的值</p>
</li>
<li>
<p>密码：这里要配置mycat-server配置文件server.xml中user标签中，property name=&quot;password&quot;配置的密码。</p>
</li>
</ul>
<h2 id="4-读写分离">4.读写分离</h2>
<h3 id="1-介绍-4">1.介绍</h3>
<ul>
<li>读写分离,简单地说是把对数据库的读和写操作分开,以对应不同的数据库服务器。主数据库提供写操作，从数据库提供读操作，这样能有效地减轻单台数据库的压力。</li>
<li>通过MyCat即可轻易实现上述功能，不仅可以支持MySQL，也可以支持Oracle和SQL Server。</li>
</ul>
<h3 id="2-一主一从">2.一主一从</h3>
<h4 id="1-原理">1.原理</h4>
<ul>
<li>MySQL的主从复制，是基于二进制日志（binlog）实现的。</li>
</ul>
<h4 id="2-环境准备-2">2.环境准备</h4>
<ul>
<li>搭建主从结构</li>
</ul>
<h3 id="3-一主一从读写分离">3.一主一从读写分离</h3>
<h4 id="1-配置">1.配置</h4>
<ul>
<li>在schema.xml文件中配置主库writeHost host=“master” url=和从库readHost host=“slave” url=的ip地址</li>
</ul>
<p># 从库的需要自行添加</p>
<ul>
<li>
<p>还要在server.xml中的user标签中的schemas中新增逻辑库，增加权限</p>
</li>
<li>
<p>MyCat控制后台数据库的读写分离和负载均衡由schema.xml文件datahost标签的balance属性控制，将参数值修改为1或3</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost 与备用的writeHost都参与select语句的负载均衡（主要针对于双主双从模式）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost，readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行,writeHost不负担读压力</td>
</tr>
</tbody>
</table>
<h4 id="2-问题">2.问题</h4>
<ul>
<li>主节点Master宕机之后,业务系统就只能够读,而不能写入数据了。</li>
</ul>
<h3 id="4-双主双从">4.双主双从</h3>
<h4 id="1-介绍-5">1.介绍</h4>
<ul>
<li>一个主机 Master1 用于处理所有写请求，它的从机 Slave1和另一台主机 Master2 还有它的从机库Slave2负责所有读请求。当Master1主机宕机后，Master2 主机负责写请求，Master1、Master2 互为备机。</li>
</ul>
<h4 id="2-环境准备-3">2.环境准备</h4>
<ul>
<li>共需要5台服务器，1台中间件，2台主库，2台从库</li>
<li>全部关闭防火墙</li>
</ul>
<h4 id="3-搭建-2">3.搭建</h4>
<h5 id="1-修改主库1的配置文件-etc-my-cnf">1.修改主库1的配置文件/etc/my.cnf</h5>
<ul>
<li><strong>server-id=1</strong></li>
</ul>
<p># mysql服务id，保证整个集群环境中唯一，取值范围：1~2^32-1，默认为1</p>
<ul>
<li><strong>binlog-do-db=数据库名</strong></li>
</ul>
<p># 指定同步的数据库,需要写三句来同步三个数据库</p>
<ul>
<li><strong>log-slave-updates</strong></li>
</ul>
<p># 在作为从库时，有写入操作也要更新二进制日志文件</p>
<h5 id="2-重启mysql服务">2.重启mysql服务</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<h5 id="3-修改主库2的配置文件-etc-my-cnf">3.修改主库2的配置文件/etc/my.cnf</h5>
<ul>
<li>与主库1配置相同，只需修改id</li>
</ul>
<h5 id="4-两台主库创建账户并授权">4.两台主库创建账户并授权</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> Root@密码<span class="string">&#x27;;</span></span><br></pre></td></tr></table></figure>
<p># 创建用户，并设置密码，该用户可在任意主机连接该MySQL服务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GRANT</span> REPLICATION SLAVE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p># 为用户分配主从复制权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> master status;</span><br></pre></td></tr></table></figure>
<p># 通过指令查看两台主库的二进制日志坐标</p>
<h5 id="5-修改从库1配置文件-etc-my-cnf">5.修改从库1配置文件/etc/my.cnf</h5>
<ul>
<li><strong>server-id=2</strong></li>
</ul>
<p># mysql服务id，保证整个集群环境中唯一，取值范围：1~2^32-1</p>
<h5 id="6-重启mysql服务">6.重启mysql服务</h5>
<h5 id="7-修改从库2配置文件-etc-my-cnf">7.修改从库2配置文件/etc/my.cnf</h5>
<p># 修改id</p>
<h5 id="8-从库1配置关联的主库1">8.从库1配置关联的主库1</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;对应主库ip&#x27;</span>,MASTER_USER<span class="operator">=</span><span class="string">&#x27;用户名&#x27;</span>,MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;密码&#x27;</span>,MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;二进制日志文件名&#x27;</span>,MASTER_LOG_POS<span class="operator">=</span>日志中开始的位置；</span><br></pre></td></tr></table></figure>
<p># 需要注意slave1对应的是master1，slave2对应的是master2。</p>
<h5 id="9-启动从库主从复制，查看从库状态">9.启动从库主从复制，查看从库状态</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">start</span> slave;</span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> slave status;</span><br></pre></td></tr></table></figure>
<h5 id="10-从库2配置关联的主库2">10.从库2配置关联的主库2</h5>
<ul>
<li>与从库1配置关联的主库1相同</li>
</ul>
<h5 id="11-主库之间的相互复制">11.主库之间的相互复制</h5>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST<span class="operator">=</span><span class="string">&#x27;另一个主库ip&#x27;</span>,MASTER_USER<span class="operator">=</span><span class="string">&#x27;用户名&#x27;</span>,MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;密码&#x27;</span>,MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;二进制日志文件名&#x27;</span>,MASTER_LOG_POS<span class="operator">=</span>日志中开始的位置；</span><br></pre></td></tr></table></figure>
<p># 在两台主库中都要执行指令</p>
<h5 id="12-启动从库主从复制，查看从库状态">12.启动从库主从复制，查看从库状态</h5>
<h3 id="5-双主双从读写分离">5.双主双从读写分离</h3>
<ul>
<li>在schema.xml文件中配置主库writeHost host=“master” url=和从库readHost host=“slave” url=的ip地址</li>
</ul>
<p># 两个主库从库都要配置，从库分别配置在对应主库下</p>
<ul>
<li>修改balance的数值为1</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost7&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1 dbType=&quot;</span><span class="attr">mysql</span>&quot; <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p># 新增writeType和switchType</p>
<ul>
<li>
<p>writeType</p>
<ul>
<li>0：写操作都转发到第1台writeHost, writeHost1挂了，会切换到writeHost2上；</li>
<li>1：所有的写操作都随机地发送到配置的writeHost上；</li>
</ul>
</li>
<li>
<p>switchType</p>
<ul>
<li>-1：不自动切换</li>
<li>1：自动切换</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="http://example.com">余</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/">http://example.com/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/08/27/MySQL%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B0/" title="MySQL进阶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">MySQL进阶</div></div><div class="info-2"><div class="info-item-1">MySQL进阶 1.储存引擎 1.MySQL体系结构   客户端连接器：PHP,Python，Java的JDBC等   MySQL服务端：   连接层：  连接池，用于接收客户端的连接，完成连接的处理，认证授权（校验用户名密码），校验每个客户端的权限，相关安全方案，检查是否超过最大连接数    服务层：SQL接口，完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程，函数等  SQL接口 解析器 查询优化器 缓存    引擎层：复杂数据的存储和提取，服务器通过API和存储引擎进行通信。其中含有多个可选择的引擎，不同的存储引擎有不同功能，也可以在此基础上扩展。  可插拔存储引擎  InnoDB（MySQL5.5后的默认引擎） NDB MyISAM …      存储层：主要将数据存储在文件系统之上，并完成与存储引擎的交互  系统文件 文件和日志    2.储存引擎简介  存储数据，建立索引，查询/更新数据等技术的实现方式。 存储引擎是基于表的，而不是基于库的，所以存储引擎也可以称为表类型  1.查询表的存储引擎 1show create...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/27/MySQL%E5%9F%BA%E7%A1%80%E7%AC%94%E8%AE%B0/" title="MySQL基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">MySQL基础</div></div><div class="info-2"><div class="info-item-1">MySQL基础 1. 启动和关闭 1.cmd   win加r进入运行输入cmd，ctrl加shift加enter以管理员模式运行 1net start mysql80 其中mysql80 为服务名，同样以 1net stop mysql80 结束运行。   2.服务  win加r进入运行输入services.msc ，进入后找到MySQL80 右键运行或停止。  2. 客户端连接 1.MySQL提供的工具  进入后直接输入密码连接。  2.cmd   win加r进入运行输入cmd，ctrl加shift加enter以管理员模式运行，（这里已经将mysql添加到环境变量，可以在任意路径下运行）输入 1mysql -h 127.0.0.1 -P 3306 -u root -p ，其中-h后面跟指定地址，-P （大写）后跟指定端口，（这两个可以省略），-u后跟指定用户，以root用户进行连接，-p指定密码。   3. 数据库概念及模型 1.概念  关系型数据库（RDBMS)  由二维表组成，以关系型模型为基础   使用表存储数据，格式统一，便于维护 使用SQL语句进行操作  2.数据模型...</div></div></div></a><a class="pagination-related" href="/2025/08/27/MySQL%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B0/" title="MySQL进阶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">MySQL进阶</div></div><div class="info-2"><div class="info-item-1">MySQL进阶 1.储存引擎 1.MySQL体系结构   客户端连接器：PHP,Python，Java的JDBC等   MySQL服务端：   连接层：  连接池，用于接收客户端的连接，完成连接的处理，认证授权（校验用户名密码），校验每个客户端的权限，相关安全方案，检查是否超过最大连接数    服务层：SQL接口，完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程，函数等  SQL接口 解析器 查询优化器 缓存    引擎层：复杂数据的存储和提取，服务器通过API和存储引擎进行通信。其中含有多个可选择的引擎，不同的存储引擎有不同功能，也可以在此基础上扩展。  可插拔存储引擎  InnoDB（MySQL5.5后的默认引擎） NDB MyISAM …      存储层：主要将数据存储在文件系统之上，并完成与存储引擎的交互  系统文件 文件和日志    2.储存引擎简介  存储数据，建立索引，查询/更新数据等技术的实现方式。 存储引擎是基于表的，而不是基于库的，所以存储引擎也可以称为表类型  1.查询表的存储引擎 1show create...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.webp" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">余</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">6</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/lucime470"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">MySQL运维</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.</span> <span class="toc-text">1.日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.二进制日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">1.介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">2.日志格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%97%A5%E5%BF%97%E6%9F%A5%E7%9C%8B"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">3.日志查看</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">4.日志删除</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">1.1.4.</span> <span class="toc-text">4.慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">2.主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.3.</span> <span class="toc-text">3.搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%87%86%E5%A4%87"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">1.服务器准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">2.主库配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text">1.修改配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%87%8D%E5%90%AFMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">1.2.3.2.2.</span> <span class="toc-text">2.重启MySQL服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95mysql%EF%BC%8C%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%E7%9A%84%E8%B4%A6%E5%8F%B7%EF%BC%8C%E5%B9%B6%E6%8E%88%E4%BA%88%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E6%9D%83%E9%99%90"><span class="toc-number">1.2.3.2.3.</span> <span class="toc-text">3.登录mysql，创建远程连接的账号，并授予主从复制权限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E9%80%9A%E8%BF%87%E6%8C%87%E4%BB%A4%EF%BC%8C%E6%9F%A5%E7%9C%8B%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97%E5%9D%90%E6%A0%87"><span class="toc-number">1.2.3.2.4.</span> <span class="toc-text">4.通过指令，查看二进制日志坐标</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E4%BB%8E%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">3.从库配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf-2"><span class="toc-number">1.2.3.3.1.</span> <span class="toc-text">1.修改配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%87%8D%E5%90%AFMySQL%E6%9C%8D%E5%8A%A1%E5%99%A8-2"><span class="toc-number">1.2.3.3.2.</span> <span class="toc-text">2.重启MySQL服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E7%99%BB%E5%BD%95mysql%EF%BC%8C%E8%AE%BE%E7%BD%AE%E4%B8%BB%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.3.3.3.</span> <span class="toc-text">3.登录mysql，设置主库配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%BC%80%E5%90%AF%E5%90%8C%E6%AD%A5%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.3.3.4.</span> <span class="toc-text">4.开启同步操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%9F%A5%E7%9C%8B%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E7%8A%B6%E6%80%81"><span class="toc-number">1.2.3.3.5.</span> <span class="toc-text">5.查看主从同步状态</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="toc-number">1.3.</span> <span class="toc-text">3.分库分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">1.问题分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8B%86%E5%88%86%E7%AD%96%E7%95%A5"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">2.拆分策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%AE%9E%E7%8E%B0%E6%8A%80%E6%9C%AF"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">3.实现技术</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-MyCat%E6%A6%82%E8%BF%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.MyCat概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">1.介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.概念介绍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-MyCat%E5%85%A5%E9%97%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">3.MyCat入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%9C%80%E6%B1%82"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1.需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2.环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%EF%BC%88schema-xml%EF%BC%89"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3.分片配置（schema.xml）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%EF%BC%88server-xml%EF%BC%89"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">4.分片配置（server.xml）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">5.启动服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-MyCat%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">4.MyCat配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-schema-xml"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">1.schema.xml</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-schema"><span class="toc-number">1.3.4.1.1.</span> <span class="toc-text">1.schema</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-dataNode"><span class="toc-number">1.3.4.1.2.</span> <span class="toc-text">2.dataNode</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-dataHost"><span class="toc-number">1.3.4.1.3.</span> <span class="toc-text">3.dataHost</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-rule-xml"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">2.rule.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-server-xml"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">3.server.xml</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-MyCat%E5%88%86%E7%89%87"><span class="toc-number">1.3.5.</span> <span class="toc-text">5.MyCat分片</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">1.垂直拆分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%9C%BA%E6%99%AF"><span class="toc-number">1.3.5.1.1.</span> <span class="toc-text">1.场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%87%86%E5%A4%87"><span class="toc-number">1.3.5.1.2.</span> <span class="toc-text">2.准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.1.3.</span> <span class="toc-text">3.配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95"><span class="toc-number">1.3.5.1.4.</span> <span class="toc-text">4.测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E5%85%A8%E5%B1%80%E8%A1%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.1.5.</span> <span class="toc-text">5.全局表配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">2.水平拆分</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%9C%BA%E6%99%AF-2"><span class="toc-number">1.3.5.2.1.</span> <span class="toc-text">1.场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%87%86%E5%A4%87-2"><span class="toc-number">1.3.5.2.2.</span> <span class="toc-text">2.准备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE-2"><span class="toc-number">1.3.5.2.3.</span> <span class="toc-text">3.配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">3.分片规则</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E8%8C%83%E5%9B%B4%EF%BC%88auto-sharding-long%EF%BC%89"><span class="toc-number">1.3.5.3.1.</span> <span class="toc-text">1.范围（auto-sharding-long）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%8F%96%E6%A8%A1%EF%BC%88mod-long%EF%BC%89"><span class="toc-number">1.3.5.3.2.</span> <span class="toc-text">2.取模（mod-long）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%80%E8%87%B4%E6%80%A7hash%EF%BC%88sharding-by-murmur%EF%BC%89"><span class="toc-number">1.3.5.3.3.</span> <span class="toc-text">3.一致性hash（sharding-by-murmur）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E6%9E%9A%E4%B8%BE%EF%BC%88sharding-by-intfile%EF%BC%89"><span class="toc-number">1.3.5.3.4.</span> <span class="toc-text">4.枚举（sharding-by-intfile）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E5%BA%94%E7%94%A8%E6%8C%87%E5%AE%9A%EF%BC%88sharding-by-substring%EF%BC%89"><span class="toc-number">1.3.5.3.5.</span> <span class="toc-text">5.应用指定（sharding-by-substring）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E5%9B%BA%E5%AE%9A%E5%88%86%E7%89%87hash%E7%AE%97%E6%B3%95%EF%BC%88sharding-by-long-hash%EF%BC%89"><span class="toc-number">1.3.5.3.6.</span> <span class="toc-text">6.固定分片hash算法（sharding-by-long-hash）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E8%A7%A3%E6%9E%90%EF%BC%88sharding-by-stringhash%EF%BC%89"><span class="toc-number">1.3.5.3.7.</span> <span class="toc-text">7.字符串hash解析（sharding-by-stringhash）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E6%8C%89%EF%BC%88%E5%A4%A9%EF%BC%89%E6%97%A5%E6%9C%9F%E5%88%86%E7%89%87%EF%BC%88sharding-by-date%EF%BC%89"><span class="toc-number">1.3.5.3.8.</span> <span class="toc-text">8.按（天）日期分片（sharding-by-date）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E6%8C%89%E8%87%AA%E7%84%B6%E6%9C%88%E5%88%86%E7%89%87%EF%BC%88sharding-by-month%EF%BC%89"><span class="toc-number">1.3.5.3.9.</span> <span class="toc-text">9.按自然月分片（sharding-by-month）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-MyCat%E7%AE%A1%E7%90%86%E5%8F%8A%E7%9B%91%E6%8E%A7"><span class="toc-number">1.3.6.</span> <span class="toc-text">6.MyCat管理及监控</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-MyCat%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">1.MyCat原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-MyCat%E7%AE%A1%E7%90%86"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">2.MyCat管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-MyCat-eye"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">3.MyCat-eye</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.4.</span> <span class="toc-text">4.读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D-4"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="toc-number">1.4.2.</span> <span class="toc-text">2.一主一从</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">1.原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-2"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">2.环境准备</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.一主一从读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">1.配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">2.问题</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E"><span class="toc-number">1.4.4.</span> <span class="toc-text">4.双主双从</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%8B%E7%BB%8D-5"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">1.介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87-3"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">2.环境准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%90%AD%E5%BB%BA-2"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">3.搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E4%BF%AE%E6%94%B9%E4%B8%BB%E5%BA%931%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf"><span class="toc-number">1.4.4.3.1.</span> <span class="toc-text">1.修改主库1的配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E9%87%8D%E5%90%AFmysql%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.4.3.2.</span> <span class="toc-text">2.重启mysql服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%BF%AE%E6%94%B9%E4%B8%BB%E5%BA%932%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf"><span class="toc-number">1.4.4.3.3.</span> <span class="toc-text">3.修改主库2的配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E4%B8%A4%E5%8F%B0%E4%B8%BB%E5%BA%93%E5%88%9B%E5%BB%BA%E8%B4%A6%E6%88%B7%E5%B9%B6%E6%8E%88%E6%9D%83"><span class="toc-number">1.4.4.3.4.</span> <span class="toc-text">4.两台主库创建账户并授权</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E4%BF%AE%E6%94%B9%E4%BB%8E%E5%BA%931%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf"><span class="toc-number">1.4.4.3.5.</span> <span class="toc-text">5.修改从库1配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-%E9%87%8D%E5%90%AFmysql%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.4.3.6.</span> <span class="toc-text">6.重启mysql服务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E4%BF%AE%E6%94%B9%E4%BB%8E%E5%BA%932%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-my-cnf"><span class="toc-number">1.4.4.3.7.</span> <span class="toc-text">7.修改从库2配置文件&#x2F;etc&#x2F;my.cnf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E4%BB%8E%E5%BA%931%E9%85%8D%E7%BD%AE%E5%85%B3%E8%81%94%E7%9A%84%E4%B8%BB%E5%BA%931"><span class="toc-number">1.4.4.3.8.</span> <span class="toc-text">8.从库1配置关联的主库1</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E5%90%AF%E5%8A%A8%E4%BB%8E%E5%BA%93%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%8C%E6%9F%A5%E7%9C%8B%E4%BB%8E%E5%BA%93%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.4.3.9.</span> <span class="toc-text">9.启动从库主从复制，查看从库状态</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E4%BB%8E%E5%BA%932%E9%85%8D%E7%BD%AE%E5%85%B3%E8%81%94%E7%9A%84%E4%B8%BB%E5%BA%932"><span class="toc-number">1.4.4.3.10.</span> <span class="toc-text">10.从库2配置关联的主库2</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E4%B8%BB%E5%BA%93%E4%B9%8B%E9%97%B4%E7%9A%84%E7%9B%B8%E4%BA%92%E5%A4%8D%E5%88%B6"><span class="toc-number">1.4.4.3.11.</span> <span class="toc-text">11.主库之间的相互复制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-%E5%90%AF%E5%8A%A8%E4%BB%8E%E5%BA%93%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%8C%E6%9F%A5%E7%9C%8B%E4%BB%8E%E5%BA%93%E7%8A%B6%E6%80%81"><span class="toc-number">1.4.4.3.12.</span> <span class="toc-text">12.启动从库主从复制，查看从库状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.4.5.</span> <span class="toc-text">5.双主双从读写分离</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/27/MySQL%E8%BF%90%E7%BB%B4%E7%AC%94%E8%AE%B0/" title="MySQL运维">MySQL运维</a><time datetime="2025-08-27T07:53:59.828Z" title="Created 2025-08-27 15:53:59">2025-08-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/27/MySQL%E8%BF%9B%E9%98%B6%E7%AC%94%E8%AE%B0/" title="MySQL进阶">MySQL进阶</a><time datetime="2025-08-27T07:53:59.825Z" title="Created 2025-08-27 15:53:59">2025-08-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/27/MySQL%E5%9F%BA%E7%A1%80%E7%AC%94%E8%AE%B0/" title="MySQL基础">MySQL基础</a><time datetime="2025-08-27T07:53:59.821Z" title="Created 2025-08-27 15:53:59">2025-08-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/24/%E5%B0%8F%E5%85%AD%E5%A3%AC%E8%B5%B7%E8%AF%BE%E5%99%A8/" title="小六壬起课器">小六壬起课器</a><time datetime="2025-02-24T13:42:02.000Z" title="Created 2025-02-24 21:42:02">2025-02-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/02/08/1/" title="第一篇文章"><div style="background: rgb(255,117,117)"></div></a><div class="content"><a class="title" href="/2025/02/08/1/" title="第一篇文章">第一篇文章</a><time datetime="2025-02-08T07:16:16.000Z" title="Created 2025-02-08 15:16:16">2025-02-08</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By 余</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>